<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   
   <mapper namespace="com.withcare.admin.dao.AdminDAO">
   	
   	<!-- 유저 레벨 조회 -->
   	<select id="userLevel" parameterType="String" resultType="int">
   		SELECT lv_idx FROM member WHERE id = #{id}
   	</select>
   	
   	<!-- 관리자 권한 부여 -->
   		<update id="levelUpdate" parameterType="map">
		      UPDATE member SET lv_idx = #{lv_idx}
  				<if test="lv_idx == 7">
    				, admin_yn = TRUE
  				</if>
 			   WHERE id = #{id}
   		</update>
   		
   		<!-- 관리자 전용 회원 리스트 조회 -->
		<select id="adminMemberList" resultType="com.withcare.admin.dto.AdminMemberDTO">
		  SELECT 
		    m.id,
		    m.admin_yn,
		    m.block_yn,
		    m.user_del_yn,
		    m.join_date,
		    m.access_date,
		    bl.block_start_date,
		    bl.block_end_date
		  FROM member m
		  LEFT JOIN (
		    SELECT blocked_id, block_start_date, block_end_date
		    FROM block_list
		    WHERE (blocked_id, block_start_date) IN (
		      SELECT blocked_id, MAX(block_start_date)
		      FROM block_list
		      GROUP BY blocked_id
		    )
		  ) bl ON m.id = bl.blocked_id
		  <where> 
		  <!-- 검색어 있을 경우 -->
		    <if test="searchId != null and searchId != ''">
		      AND m.id LIKE CONCAT('%', #{searchId}, '%')
		    </if>
		    <!-- 차단 된 사용자 검색 -->
		    <if test="blockFilter == 'blocked'">
		      AND m.block_yn = TRUE
		    </if>
		    <!-- 차단 안 된 사용자 검색 -->
		    <if test="blockFilter == 'unblocked'">
		      AND m.block_yn = FALSE
		    </if>
		  </where>
		  <choose>
		  <!-- 검색 필드 ex) access_date, join_date -->
		    <when test="sortField != null and sortOrder != null">
		      ORDER BY ${sortField} ${sortOrder}
		    </when>
		    <otherwise>
		    <!-- 내림차순 정렬 ex) acess_date 최신순) -->
		      ORDER BY m.join_date DESC
		    </otherwise>
		  </choose>
		  <!-- start 부터 size 개 잘라서 보여줌 -->
		  LIMIT #{size} OFFSET #{start}
		</select>
   		
   </mapper>