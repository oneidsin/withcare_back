<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   
   <mapper namespace="com.withcare.post.dao.PostDAO">
   		
   		<!-- ê²Œì‹œê¸€ ìž‘ì„± -->
		<insert id="postWrite" parameterType="com.withcare.post.dto.PostDTO" useGeneratedKeys="true" keyProperty="post_idx" keyColumn="post_idx">
		    INSERT INTO post (board_idx, id, post_title, post_content, com_yn, post_blind_yn)
		    VALUES (#{board_idx}, #{id}, #{post_title}, #{post_content}, #{com_yn}, #{post_blind_yn})
		</insert>
   		
   		<!-- ìž‘ì„±ìž ì •ë³´ ê°€ì ¸ì˜¤ê¸° (post_idx ì— ë§žëŠ”) -->
   		<select id="postIdx" parameterType="int" resultType="String">
		    SELECT * FROM post WHERE post_idx = #{post_idx}
		</select>
		
   		<!-- ìž‘ì„±ìž ID ê°€ì ¸ì˜¤ê¸° (post_idx ì— ë§žëŠ”) -->
	    <select id="postWriter" parameterType="int" resultType="String">
	        SELECT id FROM post WHERE post_idx = #{post_idx}
	    </select>
		
		<!-- level ê°€ì ¸ì˜¤ê¸° (ê´€ë¦¬ìž í™•ì¸)-->
		<select id="userLevel" parameterType="String" resultType="int">
		    SELECT lv_idx FROM member WHERE id = #{id}
		</select>
   		
   		<!-- ê²Œì‹œê¸€ ìˆ˜ì • (post_idx ë¡œ ê²Œì‹œê¸€ ê°€ì ¸ì™€ì„œ ì œëª©, ë‚´ìš© ìˆ˜ì •) -->
   		<update id="postUpdate" parameterType="com.withcare.post.dto.PostDTO">
   			UPDATE post SET post_title = #{post_title}, post_content = #{post_content}
   				WHERE post_idx = #{post_idx}
   		</update>
   		
   		<!-- ê²Œì‹œê¸€ ë¸”ë¼ì¸ë“œ ì²˜ë¦¬ (ê´€ë¦¬ìž or ìž‘ì„±ìž) -->
   		<update id="postDelete" parameterType="com.withcare.post.dto.PostDTO">
   			UPDATE post SET post_blind_yn = #{post_blind_yn} WHERE post_idx = #{post_idx}
   		</update>
   		
   		<!-- ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸° -->
   		<select id="postDetail" parameterType="int" resultType="com.withcare.post.dto.PostDTO">
        	SELECT * FROM post WHERE post_idx=#{post_idx} AND (post_blind_yn = false OR post_blind_yn IS NULL)
   		</select>
   		
   		<!-- ì¡°íšŒìˆ˜ ì¦ê°€ (ìƒì„¸ë³´ê¸° ì‹œ) -->
   		<update id="upHit">
   			UPDATE post SET post_view_cnt = post_view_cnt+1 WHERE post_idx = #{post_idx}
   		</update>
   		
   		<!-- ê²Œì‹œê¸€ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ê²Œì‹œíŒ idxì— ë§žëŠ” ê²Œì‹œê¸€ë§Œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. í˜„ìž¬ 5ê°œì”© ì„¤ì •ë¨. sortì— íƒ€ìž… ì„¤ì •í•˜ë©´ ì¶”ì²œìˆœ, ìµœì‹ ìˆœìœ¼ë¡œ ë³¼ ìˆ˜ ìžˆìŒ.) -->
		<select id="postList" resultType="com.withcare.post.dto.PostDTO">
		  SELECT 
		    p.post_idx, p.board_idx, p.id, p.post_title, p.post_content,
		    p.post_view_cnt, p.com_yn, p.post_create_date, p.post_update_date, p.post_blind_yn
		  FROM post p
		  <choose>
		    <when test="param4 == 'recommend'">
		      LEFT JOIN (
		        SELECT post_idx, COUNT(*) AS like_cnt
		        FROM likeyn
		        WHERE like_type = 1
		        GROUP BY post_idx
		      ) l ON p.post_idx = l.post_idx
		    </when>
		  </choose>
		  WHERE p.board_idx = #{param3}
		    AND (p.post_blind_yn = false OR p.post_blind_yn IS NULL)
		    
		  <!-- ðŸ”¥ ê²€ìƒ‰ ì¡°ê±´ì€ ì—¬ê¸°ì„œ ë¶„ê¸° -->
		  <if test="searchType != null and keyword != null and keyword != ''">
		    <choose>
		      <when test="searchType == 'title'">
		        AND p.post_title LIKE CONCAT('%', #{keyword}, '%')
		      </when>
		      <when test="searchType == 'content'">
		        AND p.post_content LIKE CONCAT('%', #{keyword}, '%')
		      </when>
		      <when test="searchType == 'title_content'">
		        AND (p.post_title LIKE CONCAT('%', #{keyword}, '%')
		          OR p.post_content LIKE CONCAT('%', #{keyword}, '%'))
		      </when>
		      <when test="searchType == 'id'">
		        AND p.id LIKE CONCAT('%', #{keyword}, '%')
		      </when>
		    </choose>
		  </if>
		
		  <!-- ðŸ”½ ì •ë ¬ ê¸°ì¤€ -->
		  <choose>
		    <when test="param4 == 'recommend'">
		      ORDER BY IFNULL(l.like_cnt, 0) DESC, p.post_idx DESC
		    </when>
		    <otherwise>
		      ORDER BY p.post_idx DESC
		    </otherwise>
		  </choose>
		
		  LIMIT #{param2} OFFSET #{param1}
		</select>

		<!-- ì¶”ì²œ ìˆ˜ -->
		<select id="likeCnt" parameterType="int" resultType="int">
			SELECT COUNT(*) FROM likeyn WHERE post_idx=#{param1} AND like_type=1
		</select>
		
		<!-- ë¹„ì¶”ì²œ ìˆ˜ -->
		<select id="dislikeCnt" parameterType="int" resultType="int">
			SELECT COUNT(*) FROM likeyn WHERE post_idx=#{param1} AND like_type=-1
		</select>
		
		<!-- ê²Œì‹œê¸€ íŽ˜ì´ì§€ ìˆ˜ -->
		<select id="postPages" parameterType="int" resultType="int">
		    SELECT COUNT(*) FROM post WHERE board_idx = #{board_idx} AND (post_blind_yn = false OR post_blind_yn IS NULL)
			<if test="searchType != null and keyword != null and keyword != ''">
				<choose>
				  <when test="searchType == 'title'">
				    AND post_title LIKE CONCAT('%', #{keyword}, '%')
				  </when>
			      <when test="searchType == 'content'">
					  AND post_content LIKE CONCAT('%', #{keyword}, '%')
				  </when>
				  <when test="searchType == 'title_content'">
					  AND (post_title LIKE CONCAT('%', #{keyword}, '%')
					    OR post_content LIKE CONCAT('%', #{keyword}, '%'))
				  </when>
				  <when test="searchType == 'id'">
					  AND id LIKE CONCAT('%', #{keyword}, '%')
				  </when>
					 <otherwise>
					      ORDER BY post_idx DESC
					  </otherwise>
				</choose>		
			</if>  
		</select>
   		
   		<!-- ì¶”ì²œ ìœ í˜• -->
		<select id="LikeType" parameterType="map" resultType="int">
			SELECT like_type FROM likeyn WHERE id=#{param1} AND post_idx=#{param2}
		</select>
		
		<!-- ì¶”ì²œ ì‚½ìž… -->
		<insert id="likeInsert" parameterType="com.withcare.post.dto.LikeDislikeDTO">
			INSERT INTO likeyn(id, post_idx, like_type)
				VALUES(#{id}, #{post_idx}, #{like_type})
		</insert>
				
		<!-- ì¶”ì²œ ì‚­ì œ (ë™ì¼ ìœ ì €ê°€ ë™ì¼ idx ì— ë™ì¼ ìƒíƒœ ì²´í¬í•˜ë©´ ì‚­ì œí•©ë‹ˆë‹¤.) -->
		<delete id="likeDelete">
			DELETE FROM likeyn WHERE id = #{param1} AND post_idx = #{param2}
		</delete>
		
		<!-- ì¶”ì²œ ìƒíƒœ ë”°ë¼ì„œ ìˆ˜ì • -->
		<update id="likeUpdate" parameterType="com.withcare.post.dto.LikeDislikeDTO">
			UPDATE likeyn SET like_type = #{like_type}
				WHERE id = #{id} AND post_idx = #{post_idx}
		</update>
   		
   		<!-- íŒŒì¼ ì‚½ìž… -->
		<insert id="fileInsert" parameterType="com.withcare.post.dto.FileDTO" useGeneratedKeys="true" keyProperty="file_idx" keyColumn="file_idx">
		    INSERT INTO file (post_idx, file_url)
		    VALUES (#{post_idx}, #{file_url})
		</insert>
		
		<!-- íŒŒì¼ ì‚­ì œ (file_idx ê¸°ì¤€)-->
   		<delete id="fileDelete" parameterType="String">
		    DELETE FROM file WHERE file_idx = #{file_idx}
		</delete>
		
		<!-- íŒŒì¼ ì‚­ì œ (file_url ê¸°ì¤€)-->
	    <delete id="fileDeleteUrl" parameterType="String">
	        DELETE FROM file WHERE file_url = #{file_url}
	    </delete>
		
		<!-- íŒŒì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° -->
		<select id="fileInfo" parameterType="String" resultType="map">
		    SELECT file_idx, file_url, post_idx FROM file WHERE file_idx = #{file_idx}
		</select>
		
		<!-- íŒŒì¼ ìžˆëŠ” ê²Œì‹œê¸€ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° -->
		<select id="fileList" parameterType="int" resultType="map">
		    SELECT file_idx, file_url
		    FROM file
		    WHERE post_idx = #{post_idx}
		</select>
		
   </mapper>