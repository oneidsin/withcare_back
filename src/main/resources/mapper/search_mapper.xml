<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>

<mapper namespace="com.withcare.search.dao.SearchDAO">

	<!-- 검색어 저장 -->
	<insert id="insertSearch"
		parameterType="com.withcare.search.dto.SearchDTO">
		INSERT INTO search (sch_id, board_idx, sch_keyword, sch_type)
		VALUES (#{user_id}, #{board_idx},#{sch_keyword}, #{sch_type})
	</insert>

	<select id="findBoardIdxForSearch"
		parameterType="com.withcare.search.dto.SearchDTO" resultType="int">
		SELECT board_idx
		FROM post
		WHERE post_blind_yn = false
		<choose>
			<when test="sch_type == '제목'">
				AND post_title LIKE CONCAT('%', #{sch_keyword}, '%')
			</when>
			<when test="sch_type == '제목+내용'">
				AND (post_title LIKE CONCAT('%', #{sch_keyword}, '%')
				OR post_content
				LIKE CONCAT('%', #{sch_keyword}, '%'))
			</when>
			<when test="sch_type == '작성자'">
				AND id LIKE CONCAT('%', #{sch_keyword}, '%')
			</when>
		</choose>
		LIMIT 1
	</select>

	<!-- 검색 + 검색 기록 저장 -->
	<select id="getSearchResult"
		parameterType="com.withcare.search.dto.SearchDTO"
		resultType="com.withcare.search.dto.SearchResultDTO">

		<!-- 검색 결과 조회 (SELECT) -->
		SELECT
		p.post_idx,
		p.board_idx,
		p.post_title AS title,
		p.post_content AS
		content,
		p.id AS writer,
		p.post_create_date AS created_date,
		p.post_view_cnt
		FROM post p
		LEFT JOIN profile pr ON p.id = pr.id
		WHERE
		p.post_blind_yn = false
		<choose>
			<when test="sch_type == '제목'">
				AND p.post_title LIKE CONCAT('%', #{sch_keyword},
				'%')
			</when>
			<when test="sch_type == '제목+내용'">
				AND (p.post_title LIKE CONCAT('%', #{sch_keyword},
				'%')
				OR p.post_content LIKE CONCAT('%', #{sch_keyword}, '%'))
			</when>
			<when test="sch_type == '작성자'">
				AND p.id LIKE CONCAT('%', #{sch_keyword}, '%')
			</when>
		</choose>
	</select>

	<!-- ✅ 최근 검색어 조회 (선택 기능) -->
	<select id="recentSearches" parameterType="String"
		resultType="com.withcare.search.dto.SearchDTO">
		SELECT *
		FROM search
		WHERE sch_id = #{user_id}
		ORDER BY
		sch_date DESC
		LIMIT 10
	</select>

</mapper>