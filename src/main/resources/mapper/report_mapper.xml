<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.withcare.report.dao.ReportDAO">

<!-- 신고 카테고리 불러오기 -->
<select id="reportCateList" resultType="map">
  SELECT * FROM report_category
</select>

<!-- 신고 카테고리 중복 체크 -->
<select id="checkDuplicateCate" parameterType="map" resultType="int">
  SELECT COUNT(*) 
  FROM report_category 
  WHERE cate_name = #{cate_name}
</select>

<!-- 신고 카테고리 수정 시 중복 체크 (현재 카테고리 제외) -->
<select id="checkDuplicateCateForUpdate" parameterType="map" resultType="int">
  SELECT COUNT(*) 
  FROM report_category 
  WHERE cate_name = #{cate_name}
  AND rep_cate_idx != #{rep_cate_idx}
</select>

<!-- 신고 카테고리 추가 -->
<insert id="reportCateAdd" parameterType="map">
  INSERT INTO report_category (cate_name, cate_active_yn)
  VALUES (#{cate_name}, true)
</insert>

<!-- 신고 카테고리 수정 -->
<update id="reportCateUpdate" parameterType="map">
  UPDATE report_category
  SET cate_name = #{cate_name}
  WHERE rep_cate_idx = #{rep_cate_idx}
</update>

<!-- 신고 카테고리 활성화 여부 -->
<update id="reportCateActive" parameterType="map">
  UPDATE report_category
  SET cate_active_yn = #{cate_active_yn}
  WHERE rep_cate_idx = #{rep_cate_idx}
</update>



<!-- 유저가 신고하는 기능들 -->
<!-- 신고하기 전 중복 체크 -->
<select id="checkDuplicateReport" parameterType="map" resultType="int">
  SELECT COUNT(*) 
  FROM report 
  WHERE reporter_id = #{reporter_id}
  AND rep_item_type = #{rep_item_type}
  AND rep_item_idx = #{rep_item_idx}
</select>

<!-- 신고하기 -->
<insert id="report" parameterType="com.withcare.report.dto.ReportDTO" useGeneratedKeys="true" keyProperty="rep_idx">
  INSERT INTO report (
  reporter_id,
  reported_id,
  rep_cate_idx,
  rep_item_type,
  status,
  rep_item_idx
  ) VALUES (
  #{reporter_id},
  #{reported_id},
  #{rep_cate_idx},
  #{rep_item_type},
  '미처리',
  #{rep_item_idx}
  )
</insert>

<!-- 중복 신고 확인 -->
<select id="isDuplicateReport" resultType="boolean">
  SELECT COUNT(*) > 0
  FROM report
  WHERE reporter_id = #{reporterId}
  AND rep_item_idx = #{itemIdx}
  AND rep_item_type = #{itemType}
</select>

<!-- 카테고리 유효성 검사 -->
<select id="checkCategoryValid" resultType="boolean">
  SELECT COUNT(*) > 0
  FROM report_category
  WHERE rep_cate_idx = #{categoryIdx}
  AND cate_active_yn = true
</select>

<!-- 게시물 작성자 ID 조회 -->
<select id="postWriter" resultType="string">
  SELECT id 
  FROM post 
  WHERE post_idx = #{itemIdx}
</select>

<!-- 댓글 작성자 ID 조회 -->
<select id="commentWriter" resultType="string">
  SELECT id 
  FROM comment 
  WHERE com_idx = #{itemIdx}
</select>

<!-- 멘션 작성자 ID 조회 -->
<select id="mentionWriter" resultType="string">
  SELECT men_writer_id 
  FROM mention 
  WHERE men_idx = #{itemIdx}
</select>

<!-- 신고 히스토리 리스트에 등록 -->
<insert id="insertReportHistory" parameterType="map">
  INSERT INTO report_history (
    rep_idx,
    rep_admin_id,
    rep_yn
  ) VALUES (
    #{rep_idx},
    #{rep_admin_id},
    '미처리'
  )
</insert>

<select id="reportList" resultType="map">
  SELECT
    rh.rep_list_idx,
    r.rep_idx,
    r.rep_item_type,
    r.rep_item_idx,
    r.reporter_id,
    r.reported_id,
    r.report_at,
    rc.cate_name AS report_category,
    p.post_idx,
    p.post_title,
    c.com_idx,
    c.com_content,
    m.men_idx,
    m.men_content,
    
    COALESCE(p.post_idx, c.post_idx, pc.post_idx) AS target_post_idx

    FROM report_history rh

    JOIN report r ON rh.rep_idx = r.rep_idx

    LEFT JOIN report_category rc ON r.rep_cate_idx = rc.rep_cate_idx

    LEFT JOIN post p ON r.rep_item_type = 'post' AND r.rep_item_idx = p.post_idx

    LEFT JOIN comment c ON r.rep_item_type = 'comment' AND r.rep_item_idx = c.com_idx

    LEFT JOIN mention m ON r.rep_item_type = 'mention' AND r.rep_item_idx = m.men_idx

    LEFT JOIN comment mc ON m.com_idx = mc.com_idx
    LEFT JOIN post pc ON mc.post_idx = pc.post_idx

    ORDER BY rh.process_date DESC;

</select>


</mapper>